<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="./css/Chart.css">
    <link rel="stylesheet" type="text/css" href="./css/customChart.css">
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Open+Sans" />
    <script src="./js/Chart.min.js"></script>
    <script src="./js/jquery-3.4.1.min.js"></script>
    <script src="./chart.js/samples/utils.js"></script>
    <script src="./js/utils.js"></script>
    <title>chart.js Test</title>
   </head>
<body>

<!--<div class="chart-container" style=" height:193px; width:490px;border: 1px dashed #bcbcbc;">-->
<!--    <canvas id="monthlyDoughnutChartBasic" ></canvas>-->
<!--    <br>-->
<!--    <br>-->
<!--    <button id="randomizeData">데이터 갱신</button>-->
<!--</div>-->

<div class="chart-container" style="position: relative; height:193px; width:490px; border: 1px dashed #bcbcbc;">
        <div class="float-left" style="position: relative;width:182px;height:154px;padding: 22px;">
            <canvas id="monthlyDoughnutChart" style="position: relative;"></canvas>
        </div>
    <div class="doughnut-custom-legend float-left" style="width:264px; height:193px ">
        <div id="doughnutLegend" class="chart-legend">
        </div>
    </div>
</div>
<br>
<br>
<button id="randomizeData">데이터 갱신</button>
    <script>
        // @todo 1. 툴팁 label 한픽셀 위로.
        //
        var totalDataNum = 0;
        var labelArr = [];
        var priceArr = [];
        var perArr = [];
        var colorsArr = [];
        var totalPrice = 0;

        var config = null;
        var basicConfig = null;
        // API 애서 받은 데이어 여기에 대입
        var chartData = {};

        var randomScalingFactor = function() {
            return Math.round(Math.random() * 100);
        };
        // 데이터셋 랜덤으로 뿌리기
        function randomDataset(){
            return (Samples.utils.rand(100, 200));
        }
        // API 에서 받은 데이터를 Chart에 넣을 데이터로 변환.
        function setChartData(dataObj){
            totalDataNum = 15;
            labelArr = new Array(totalDataNum);
            perArr = new Array(totalDataNum);
            priceArr = new Array(totalDataNum);
            for(var i=0; i<totalDataNum; i++) {
                labelArr[i] = "AWSDatabaseMigrationSvc"+(i+1);
                priceArr[i] = randomDataset();
                colorsArr[i] = Common.utils.getRandomColor();
                totalPrice += priceArr[i];
            }
            for(var i=0; i<totalDataNum; i++) {
                perArr[i] = Math.round((priceArr[i]/totalPrice)*100);
            }
        }

        // 범례 새로 생성
        function setLegend(){
            $("#doughnutLegend").html(monthlyDoughnutChart.generateLegend());
            $("#doughnutLegend > ul > li").on("click",function(e){
                var index = $(this).index();
                $(this).toggleClass("strike")
                var ci = e.view.monthlyDoughnutChart;
                //var meta = ci.getDatasetMeta(index);
                var curr = ci.data.datasets[0]._meta[0].data[index];

                curr.hidden = !curr.hidden;
                /*if (meta.dataset) {
                     meta.hidden = !meta.hidden;
                } else {
                     meta.data[index].hidden = !meta.data[index].hidden;
                 }*/

                // We hid a dataset ... rerender the chart
                ci.update();
            })
        }

        function setChartConfig(){
            config = {
                type: 'doughnut',
                labels: labelArr,
                data: {
                    datasets: [{
                        data: priceArr,
                        backgroundColor: colorsArr,
                        borderWidth: 0,
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    cutoutPercentage : 57,
                    legend: {
                        display:false,
                        position: 'right',
                        align : 'start',
                        fullWidth : false,
                        labels: {
                            fontSize : 14,
                            boxWidth: 12,
                            // fontFamily : "OpenSans",
                            fontColor: '#555555'
                        }
                    },
                    animation: {
                        animateScale: true,
                        animateRotate: true
                    },
                    tooltips: {
                        backgroundColor: "#15283b",
                        yAlign: 'bottom',
                        xAlign: 'center',
                        bodyAlign: 'center',
                        bodyFontSize: 12,
                        cornerRadius: 15,
                        yPadding : 8,
                        xPadding : 8,
                        custom: function(tooltip) {
                            if (!tooltip) return;
                            // 툴팁에 앞 박스 안나오게
                            tooltip.displayColors = false;

                            // 툴팁 masking 되는거 패칭
                            if(tooltip.y < 0){
                                tooltip.yAlign = 'top';
                                tooltip.y = tooltip.y + tooltip.height + (tooltip.height/2);
                            }else{
                                tooltip.yAlign = 'bottom';
                            }

                        },
                        callbacks: {
                            title: function(tooltipItem, data) {
                                return ;
                            },
                            label: function(tooltipItem, data) {
                                var price = priceArr[tooltipItem.index] || '';

                                price = Math.round(price * 100) / 100;
                                return "$"+price+" ("+perArr[tooltipItem.index]+"%)";
                            },
                            labelTextColor: function(tooltipItem, chart) {
                                return '#ffffff';
                            }
                        }
                    }
                }
            };
        }

        function init(){
            setChartData();
            setChartConfig();
            Chart.defaults.global.defaultFontFamily = "Open Sans";
            window.monthlyDoughnutChart = new Chart(monthlyDoughnutChart, config);
            setLegend();
            setButtons();
        }
        // 필요 없는 부분.
        function setButtons(){
            $('#randomizeData').on('click', function() {
                config.data.datasets.forEach(function(dataset) {
                    dataset.data = dataset.data.map(function() {
                        return randomDataset();
                    });
                });
                window.monthlyDoughnutChart.update();
            });
        }
        window.onload = init;



        /*
       function setBasicChartConfig(){
           basicConfig = {
               type: 'doughnut',
               data: {
                   datasets: [{
                       data: priceArr,
                       backgroundColor: colorsArr,
                       borderWidth: 0,
                   }],
                   labels: labelArr
               },
               options: {
                   legend: {
                       display:true,
                       position: 'right',
                       align : 'start',
                       fullWidth : false,
                       labels: {
                           fontSize : 14,
                           boxWidth: 12,
                           // fontFamily : "OpenSans",
                           fontColor: '#555555',

                       }
                   },
                   animation: {
                       animateScale: true,
                       animateRotate: true
                   },
                   tooltips: {
                       backgroundColor: "#15283b",
                       yAlign: 'bottom',
                       xAlign: 'center',
                       bodyAlign: 'center',
                       bodyFontSize: 12,
                       cornerRadius: 15,
                       yPadding : 8,
                       xPadding : 8,
                       custom: function(tooltip) {
                           if (!tooltip) return;
                           // 툴팁에 앞 박스 안나오게
                           tooltip.displayColors = false;
                       },
                       callbacks: {
                           title: function(tooltipItem, data) {
                               return ;
                           },
                           label: function(tooltipItem, data) {
                               var price = priceArr[tooltipItem.index] || '';

                               price = Math.round(price * 100) / 100;
                               return "$"+price+" ("+perArr[tooltipItem.index]+"%)";
                           },
                           labelTextColor: function(tooltipItem, chart) {
                               return '#ffffff';
                           }
                       }
                   }
               }
           };
       }
       */
    </script>
</body>
</html>